#███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗  
#██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║  
#██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║  
#██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║  
#███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║  
#╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝  
#                                                                                                                                                                      
#███████╗██████╗  ██████╗    ██████╗ ███████╗███████╗██╗ ██████╗██╗████████╗     ██████╗ █████╗ ██╗      ██████╗██╗   ██╗██╗      █████╗ ████████╗ ██████╗ ██████╗ 
#██╔════╝██╔══██╗██╔════╝    ██╔══██╗██╔════╝██╔════╝██║██╔════╝██║╚══██╔══╝    ██╔════╝██╔══██╗██║     ██╔════╝██║   ██║██║     ██╔══██╗╚══██╔══╝██╔═══██╗██╔══██╗
#███████╗██████╔╝██║         ██║  ██║█████╗  █████╗  ██║██║     ██║   ██║       ██║     ███████║██║     ██║     ██║   ██║██║     ███████║   ██║   ██║   ██║██████╔╝
#╚════██║██╔══██╗██║         ██║  ██║██╔══╝  ██╔══╝  ██║██║     ██║   ██║       ██║     ██╔══██║██║     ██║     ██║   ██║██║     ██╔══██║   ██║   ██║   ██║██╔══██╗
#███████║██████╔╝╚██████╗    ██████╔╝███████╗██║     ██║╚██████╗██║   ██║       ╚██████╗██║  ██║███████╗╚██████╗╚██████╔╝███████╗██║  ██║   ██║   ╚██████╔╝██║  ██║
#╚══════╝╚═════╝  ╚═════╝    ╚═════╝ ╚══════╝╚═╝     ╚═╝ ╚═════╝╚═╝   ╚═╝        ╚═════╝╚═╝  ╚═╝╚══════╝ ╚═════╝ ╚═════╝ ╚══════╝╚═╝  ╚═╝   ╚═╝    ╚═════╝ ╚═╝  ╚═╝
#                                                                                                                                                                      
#███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗  
#██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║  
#██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║  
#██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║  
#███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║  
#╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝  

# Authored by Brodie Verrall
# Last updated: 2025-09-01

#$$$ This script calculates the site deficit for each preclear RE1 from v14, accounting for analogous, replacement and combined REs
#TODO: ensure the latest statewide training data, analogous/replacement/combined REs, and parquets from most recent model run is maintained and imported

##### 1) Workspace setup #####
#  ██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗
# ╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝
#               ██╗       ██╗    ██╗ ██████╗ ██████╗ ██╗  ██╗███████╗██████╗  █████╗  ██████╗███████╗    ███████╗███████╗████████╗██╗   ██╗██████╗ 
#              ███║       ██║    ██║██╔═══██╗██╔══██╗██║ ██╔╝██╔════╝██╔══██╗██╔══██╗██╔════╝██╔════╝    ██╔════╝██╔════╝╚══██╔══╝██║   ██║██╔══██╗
#              ╚██║       ██║ █╗ ██║██║   ██║██████╔╝█████╔╝ ███████╗██████╔╝███████║██║     █████╗      ███████╗█████╗     ██║   ██║   ██║██████╔╝
#               ██║       ██║███╗██║██║   ██║██╔══██╗██╔═██╗ ╚════██║██╔═══╝ ██╔══██║██║     ██╔══╝      ╚════██║██╔══╝     ██║   ██║   ██║██╔═══╝ 
#               ██║██╗    ╚███╔███╔╝╚██████╔╝██║  ██║██║  ██╗███████║██║     ██║  ██║╚██████╗███████╗    ███████║███████╗   ██║   ╚██████╔╝██║     
#               ╚═╝╚═╝     ╚══╝╚══╝  ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝╚══════╝╚═╝     ╚═╝  ╚═╝ ╚═════╝╚══════╝    ╚══════╝╚══════╝   ╚═╝    ╚═════╝ ╚═╝     
#  ██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗
# ╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝
# 1.1) Run renv/activate.R to set project environment
# renv::status()
rm(list=ls())
gc()

# 1.2) Install and load project library
# List of required packages
packages <- c("dplyr", "tidyr", "stringr", "arrow", "sf")
installed_packages <- rownames(installed.packages())
for (pkg in packages) {
  if (!pkg %in% installed_packages) {
    install.packages(pkg)
  }
}
lapply(packages, library, character.only = TRUE)

####################################################### FIXME: Update the file paths to stop creating project_data loop#########################################
# 1.3) Create directories and set wd
main_folder <- "project_data"
inputs_folder <- file.path(main_folder, "inputs")
outputs_folder <- file.path(main_folder, "outputs")
if (!dir.exists(main_folder)) {
  dir.create(main_folder)
  cat("Created folder:", main_folder, "\n")
} else {
  cat("Folder already exists:", main_folder, "\n")
}
if (!dir.exists(inputs_folder)) {
  dir.create(inputs_folder)
  cat("Created folder:", inputs_folder, "\n")
} else {
  cat("Folder already exists:", inputs_folder, "\n")
}
if (!dir.exists(outputs_folder)) {
  dir.create(outputs_folder)
  cat("Created folder:", outputs_folder, "\n")
} else {
  cat("Folder already exists:", outputs_folder, "\n")
}
setwd("project_data/")

# 1.4) Import data
### TODO: Only import TD and RE base products as well as analogous and supplementation. Script updated to generate all other dependancies

TD_WOS <- read.csv("inputs/TD_WOSv7.7_20250506.csv") # TODO: ensure this is up to date -----------------------------------------------------------> Updated on 06/05/25 with all trips to date
# REDDv13 <- read.csv("inputs/REDD_v13_2023.csv") # TODO: ensure this is up to date
RE_v14_2023 <- read.csv("inputs/v14/regional_ecosystem.csv") # TODO: ensure this is up to date

SBC_RE1_PC <- read.csv("inputs/v14/PRECLEARING_RE_V14_SBCfilter.csv") # TODO: ensure this is up to date
REMNANT_RE_V13_ha <- read.csv("inputs/REMNANT_RE_V13_ha.csv") # TODO: ensure this is up to date
PRECLEAR_RE_V13_ha <- read.csv("inputs/PRECLEAR_RE_V13_ha.csv") # TODO: ensure this is up to date

SBC_RE_SUPP <- read.csv("inputs/SBC_supplementation_REV13.csv") # TODO: ensure this is up to date
LRA_distance <- read_parquet("inputs/2021_BRB-CQC-MUL-SEQ_analogous/distance_100.parquet") # TODO: ensure this is up to date
LRA_reference <- read_parquet("inputs/2021_BRB-CQC-MUL-SEQ_analogous/reference_data_100.parquet") # TODO: ensure this is up to date
LRA_training <- read_parquet("inputs/2021_BRB-CQC-MUL-SEQ_analogous/sampled_data_clean_100.parquet") # TODO: ensure this is up to date
LRA_REs <- read.csv("inputs/2021_BRB-CQC-MUL-SEQ_analogous/SEQBRBCQCMUL_analogous_REs_v1.0.csv") # TODO: ensure this is up to date
LRR_distance <- read_parquet("inputs/2021_BRB-CQC-MUL-SEQ_replacement/distance_100.parquet") # TODO: ensure this is up to date
LRR_reference <- read_parquet("inputs/2021_BRB-CQC-MUL-SEQ_replacement/reference_data_100.parquet") # TODO: ensure this is up to date
LRR_REs <- read.csv("inputs/2021_BRB-CQC-MUL-SEQ_replacement/SEQBRBCQCMUL_re_replacement_v1.0.csv") # TODO: ensure this is up to date
LRC_distance <- read_parquet("inputs/2021_BRB-CQC-MUL-SEQ_combined/distance_100.parquet") # TODO: ensure this is up to date
LRC_reference <- read_parquet("inputs/2021_BRB-CQC-MUL-SEQ_combined/reference_data_100.parquet") # TODO: ensure this is up to date
LRC_REs <- read.csv("inputs/2021_BRB-CQC-MUL-SEQ_combined/SEQBRBCQCMUL_combined_REs_v1.0.csv") # TODO: ensure this is up to date

##### 2) Data processing #####                                                                                                                                                                    
# ██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗
# ╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝
#               ██████╗        ██████╗  █████╗ ████████╗ █████╗     ██████╗ ██████╗  ██████╗  ██████╗███████╗███████╗███████╗██╗███╗   ██╗ ██████╗                
#               ╚════██╗       ██╔══██╗██╔══██╗╚══██╔══╝██╔══██╗    ██╔══██╗██╔══██╗██╔═══██╗██╔════╝██╔════╝██╔════╝██╔════╝██║████╗  ██║██╔════╝                
#                █████╔╝       ██║  ██║███████║   ██║   ███████║    ██████╔╝██████╔╝██║   ██║██║     █████╗  ███████╗███████╗██║██╔██╗ ██║██║  ███╗               
#               ██╔═══╝        ██║  ██║██╔══██║   ██║   ██╔══██║    ██╔═══╝ ██╔══██╗██║   ██║██║     ██╔══╝  ╚════██║╚════██║██║██║╚██╗██║██║   ██║               
#               ███████╗██╗    ██████╔╝██║  ██║   ██║   ██║  ██║    ██║     ██║  ██║╚██████╔╝╚██████╗███████╗███████║███████║██║██║ ╚████║╚██████╔╝               
#               ╚══════╝╚═╝    ╚═════╝ ╚═╝  ╚═╝   ╚═╝   ╚═╝  ╚═╝    ╚═╝     ╚═╝  ╚═╝ ╚═════╝  ╚═════╝╚══════╝╚══════╝╚══════╝╚═╝╚═╝  ╚═══╝ ╚═════╝                
# ██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗
# ╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝
                                                                                                                                                                   

#----------------------------------------------------------------------------------------------------------------------#
#----------------------------------------------- 2) Data manipulation -------------------------------------------------#
#----------------------------------------------------------------------------------------------------------------------#

# 2.1) Manipulate dataframes
TD_WOS <- TD_WOS %>%
  mutate(temp = V13_RE) %>%
  separate(temp, into = c("BR_code", "LZ_code", "VC_code"), sep = "\\.")
RE_v13_2023 <- RE_v13_2023 %>%
  mutate(temp = NAME) %>%
  separate(temp, into = c("BR_code", "LZ_code", "VC_code"), sep = "\\.") %>%
  mutate(temp = MAPPED_EXTENTS) %>%
  separate(temp, into = c("PRECLEAR_ha", "REMNANT_ha"), sep = "\\;")
RE_v13_2023$PRECLEAR_ha <- as.numeric(gsub("[^0-9]", "", RE_v13_2023$PRECLEAR_ha))
RE_v13_2023$REMNANT_ha <- as.numeric(gsub("2021|[^0-9]", "", RE_v13_2023$REMNANT_ha))

# remove columns 2 to 4 to align with analogous df format, and add supp and analogous to form combined REs
QLD_RE_SUPP <- SBC_RE_SUPP[, -c(2:4)]
SuppAna_REs <- rbind(LRA_REs, QLD_RE_SUPP)

# Group SBC filtered RE1 polygons into RE1 groups (QLDv13 = 2705 RE1s) to be modelled
SBC_RE1_PC_GROUPED <- SBC_RE1_PC %>%
  group_by(RE1) %>%
  summarize(across(everything(), list))
SBC_RE1_PC_GROUPED_FILTERED <- SBC_RE1_PC_GROUPED %>%
  mutate(temp = RE1) %>%
  separate(temp, into = c("BR_code", "LZ_code", "VC_code"), sep = "\\.") %>%
  select(RE1, BR_code, LZ_code, VC_code) %>% # Select specific columns first, then others if needed
  filter(LZ_code != 1) # Remove rows where LZ_code == 1


################################################################################################################################################################
# Ensure QGIS calculated extents are numeric
REMNANT_RE_V13_ha$Remnant_qgis_ha <- as.numeric(REMNANT_RE_V13_ha$Remnant_ha)
PRECLEAR_RE_V13_ha$Preclear_qgis_ha <- as.numeric(PRECLEAR_RE_V13_ha$Preclear_ha)

# Merge and compare RE extents to QGIS area calculations
EXTENT_v13 <- PRECLEAR_RE_V13_ha %>%
  left_join(REMNANT_RE_V13_ha, by = c("RE1_pre" = "RE1_rem")) %>%
  mutate(
    Preclear_qgis_ha = as.numeric(Preclear_qgis_ha),
    Remnant_qgis_ha  = as.numeric(Remnant_qgis_ha),
    Difference_ha    = Preclear_qgis_ha - Remnant_qgis_ha
  )

EXTENT_v13$RE_parent <- gsub("([a-zA-Z].*)$", "", EXTENT_v13$RE1_pre)


# # Ensure QGIS calculated extents are numeric
# REMNANT_RE_V13_ha$Remnant_qgis_ha <- as.numeric(REMNANT_RE_V13_ha$Remnant_ha)
# PRECLEAR_RE_V13_ha$Preclear_qgis_ha <- as.numeric(PRECLEAR_RE_V13_ha$Preclear_ha)
# 
# # Merge and compare RE extents to QGIS area calculations
# EXTENT_v13 <- PRECLEAR_RE_V13_ha %>%
#   left_join(REMNANT_RE_V13_ha, by = c("RE1_pre" = "RE1_rem"))
# EXTENT_v13$Difference_ha <- EXTENT_v13$Preclear_ha - EXTENT_v13$Remnant_ha
# EXTENT_v13$Difference_ha <- as.integer(EXTENT_v13$Difference_ha)
# EXTENT_v13$Preclear_qgis_ha <- as.integer(EXTENT_v13$Preclear_qgis_ha)
# EXTENT_v13$Remnant_qgis_ha <- as.integer(EXTENT_v13$Remnant_qgis_ha)
# 
# format_number <- function(x, digits = 2) {
#   format(x, nsmall = digits, scientific = FALSE)
# }
# EXTENT_v13$Preclear_qgis_ha <- format_number(EXTENT_v13$Preclear_ha, digits = 2)
# EXTENT_v13$Remnant_qgis_ha <- format_number(EXTENT_v13$Remnant_ha, digits = 2)
# EXTENT_v13$Difference_ha <- format_number(EXTENT_v13$Difference_ha, digits = 2)
# EXTENT_v13$RE_parent <- gsub("([a-zA-Z].*)$", "", EXTENT_v13$RE1_pre)

################################################################################################################################################################

# 2.2) Calculate baseline reference state site for each RE
td_wos_ref <- TD_WOS %>%
  filter(SCORE == -1 | SCORE > 80)
td_ref_counts <- td_wos_ref %>%
  group_by(V13_RE) %>%
  summarise(TD_ref_sites = n(), .groups = 'drop')

###############################################################################################################################################################
###############################################################################################################################################################
###############################################################################################################################################################

# 2.3 Calculate reference state site for each RE accounting for supplement REs
get_total_ref_sites <- function(re, ref_counts, QLD_RE_SUPP) {
  analogous_res <- QLD_RE_SUPP %>%
    filter(V13_RE1 == re) %>%
    unlist(use.names = FALSE) %>%
    na.omit()
  total_analogous_sites <- ref_counts %>%
    filter(V13_RE %in% analogous_res) %>%
    summarise(total_sites = sum(TD_ref_sites, na.rm = TRUE)) %>%
    pull(total_sites)
  base_re_sites <- ref_counts %>%
    filter(V13_RE == re) %>%
    summarise(base_sites = sum(TD_ref_sites, na.rm = TRUE)) %>%
    pull(base_sites)
  total_ref_sites <- if (length(analogous_res) > 0) {
    total_analogous_sites
  } else {
    base_re_sites
  }
  return(total_ref_sites)
}
td_ref_supp_counts <- td_ref_counts %>%
  rowwise() %>%
  mutate(TD_supplementation_ref_sites = get_total_ref_sites(V13_RE, td_ref_counts, QLD_RE_SUPP))

# 2.4) Calculate reference state site for each RE accounting for analogous REs
get_total_ref_sites <- function(re, ref_counts, LRA_REs) {
  analogous_res <- LRA_REs %>%
    filter(V13_RE1 == re) %>%
    unlist(use.names = FALSE) %>%
    na.omit()
  total_analogous_sites <- ref_counts %>%
    filter(V13_RE %in% analogous_res) %>%
    summarise(total_sites = sum(TD_ref_sites, na.rm = TRUE)) %>%
    pull(total_sites)
  base_re_sites <- ref_counts %>%
    filter(V13_RE == re) %>%
    summarise(base_sites = sum(TD_ref_sites, na.rm = TRUE)) %>%
    pull(base_sites)
  total_ref_sites <- if (length(analogous_res) > 0) {
    total_analogous_sites
  } else {
    base_re_sites
  }
  return(total_ref_sites)
}
td_ref_ana_counts <- td_ref_counts %>%
  rowwise() %>%
  mutate(TD_analogous_ref_sites = get_total_ref_sites(V13_RE, td_ref_counts, LRA_REs))


# 2.5) Calculate reference state site for each RE accounting for analogous & supplement (i.e. combined) REs
get_total_ref_sites <- function(re, ref_counts, SuppAna_REs) {
  analogous_res <- SuppAna_REs %>%
    filter(V13_RE1 == re) %>%
    unlist(use.names = FALSE) %>%
    na.omit()
  total_analogous_sites <- ref_counts %>%
    filter(V13_RE %in% analogous_res) %>%
    summarise(total_sites = sum(TD_ref_sites, na.rm = TRUE)) %>%
    pull(total_sites)
  base_re_sites <- ref_counts %>%
    filter(V13_RE == re) %>%
    summarise(base_sites = sum(TD_ref_sites, na.rm = TRUE)) %>%
    pull(base_sites)
  total_ref_sites <- if (length(analogous_res) > 0) {
    total_analogous_sites
  } else {
    base_re_sites
  }
  return(total_ref_sites)
}
td_ref_comb_counts <- td_ref_counts %>%
  rowwise() %>%
  mutate(TD_combined_ref_sites = get_total_ref_sites(V13_RE, td_ref_counts, SuppAna_REs))

# 2.5) Merge the reference counts with the REDD data and calculate deficits
td_all_ref_counts <- td_ref_counts %>%
  left_join(select(td_ref_supp_counts, V13_RE, TD_supplementation_ref_sites), by = c("V13_RE" = "V13_RE")) %>%
  left_join(select(td_ref_ana_counts, V13_RE, TD_analogous_ref_sites), by = c("V13_RE" = "V13_RE")) %>%
  left_join(select(td_ref_comb_counts, V13_RE, TD_combined_ref_sites), by = c("V13_RE" = "V13_RE"))
td_all_ref_counts <- td_all_ref_counts %>% # check if ref site values are the same
  mutate(all_same = (TD_supplementation_ref_sites == TD_analogous_ref_sites) & 
           (TD_analogous_ref_sites == TD_combined_ref_sites))


# Add training site numbers for SBC mapped RE1s to be modelled
SBC_RE1 <- SBC_RE1_PC_GROUPED_FILTERED %>%
  left_join(td_all_ref_counts, by = c("RE1" = "V13_RE")) %>%
  mutate(
    TD_ref_sites = ifelse(is.na(TD_ref_sites), 0, TD_ref_sites),
    TD_supplementation_ref_sites = ifelse(is.na(TD_supplementation_ref_sites), 0, TD_supplementation_ref_sites),
    TD_analogous_ref_sites = ifelse(is.na(TD_analogous_ref_sites), 0, TD_analogous_ref_sites),
    TD_combined_ref_sites = ifelse(is.na(TD_combined_ref_sites), 0, TD_combined_ref_sites)
  )
SBC_RE1 <- SBC_RE1 %>%
  left_join(
    RE_v13_2023 %>%
      select(
        NAME, PARENT, SHORT_DESCRIPTION, DESCRIPTION, STRUCTURE_CODE, BVG1M, DEFUNCT, PRECLEAR_ha, REMNANT_ha, EXTENT_WITHIN_PROTECTED_AREAS, 
        PROTECTED_AREAS, HABITAT, DISTRIBUTION, PUBLIC_COMMENTS, VMA_CLASS, BIODIVERSITY_STATUS, BIODIVERSITY_STATUS_NOTES 
      ),
    by = c("RE1" = "NAME") 
  )
SBC_RE1 <- SBC_RE1 %>%
  left_join(
    EXTENT_v13 %>%
      select(RE1_pre, Preclear_qgis_ha, Remnant_qgis_ha, Difference_ha),
    by = c("RE1" = "RE1_pre")
  )

##### 3) Calculate area-weighted training site deficit #####                                                                                                                                                                    
# ██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗
# ╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝
#          ██████╗         ██████╗ █████╗ ██╗      ██████╗██╗   ██╗██╗      █████╗ ████████╗███████╗    ██████╗ ███████╗███████╗██╗ ██████╗██╗████████╗
#          ╚════██╗       ██╔════╝██╔══██╗██║     ██╔════╝██║   ██║██║     ██╔══██╗╚══██╔══╝██╔════╝    ██╔══██╗██╔════╝██╔════╝██║██╔════╝██║╚══██╔══╝
#           █████╔╝       ██║     ███████║██║     ██║     ██║   ██║██║     ███████║   ██║   █████╗      ██║  ██║█████╗  █████╗  ██║██║     ██║   ██║   
#           ╚═══██╗       ██║     ██╔══██║██║     ██║     ██║   ██║██║     ██╔══██║   ██║   ██╔══╝      ██║  ██║██╔══╝  ██╔══╝  ██║██║     ██║   ██║   
#          ██████╔╝██╗    ╚██████╗██║  ██║███████╗╚██████╗╚██████╔╝███████╗██║  ██║   ██║   ███████╗    ██████╔╝███████╗██║     ██║╚██████╗██║   ██║   
#          ╚═════╝ ╚═╝     ╚═════╝╚═╝  ╚═╝╚══════╝ ╚═════╝ ╚═════╝ ╚══════╝╚═╝  ╚═╝   ╚═╝   ╚══════╝    ╚═════╝ ╚══════╝╚═╝     ╚═╝ ╚═════╝╚═╝   ╚═╝   
# ██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗
# ╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝



#######################################################################################################################################################################################################################################
### ---> Changed PRECLEAR_ha (REDD-derived value for Parent RE that does not account for vegetation sub unit) with Preclear_qgis_ha (Hectares calculated for each RE from extent of RE1 polygons). 
### This will stop the overestimatation of ref site defs for REs with sub units that have small extents.

# Calculate area-weighted training data site deficits (robust + simpler)
SBC_RE1 <- SBC_RE1 %>%
  mutate(
    Preclear_qgis_ha = as.numeric(Preclear_qgis_ha),
    Remnant_qgis_ha  = as.numeric(Remnant_qgis_ha),
    
    # Required reference sites based on area (1–5 range)
    required_ref_sites = pmin(5, pmax(1, ceiling(Preclear_qgis_ha / 400))),
    
    # Deficits under different counting rules
    TD_ref_deficit                 = required_ref_sites - TD_ref_sites,
    TD_ref_supplementation_deficit = required_ref_sites - TD_supplementation_ref_sites,
    TD_ref_analogous_deficit       = required_ref_sites - TD_analogous_ref_sites,
    TD_ref_combined_deficit        = required_ref_sites - TD_combined_ref_sites
  )


##########################################################################################################################################################################################################################################

# 2.5) Generate training data deficit dataframe
SBC_TD_DEFICIT <- SBC_RE1 %>%
  select(RE1, PARENT, BR_code, LZ_code, VC_code, SHORT_DESCRIPTION, DESCRIPTION, STRUCTURE_CODE, PRECLEAR_ha, REMNANT_ha, Preclear_qgis_ha, Remnant_qgis_ha, Difference_ha, 
         TD_ref_sites, TD_ref_deficit, TD_supplementation_ref_sites, TD_ref_supplementation_deficit, TD_analogous_ref_sites, TD_ref_analogous_deficit, TD_combined_ref_sites, 
         TD_ref_combined_deficit, EXTENT_WITHIN_PROTECTED_AREAS, PROTECTED_AREAS, HABITAT, DISTRIBUTION, PUBLIC_COMMENTS, VMA_CLASS, BIODIVERSITY_STATUS, BIODIVERSITY_STATUS_NOTES)

SBC_TD_DEFICIT$Preclear_qgis_ha <- as.numeric(as.character(SBC_TD_DEFICIT$Preclear_qgis_ha))
SBC_TD_DEFICIT$Remnant_qgis_ha  <- as.numeric(as.character(SBC_TD_DEFICIT$Remnant_qgis_ha))

# # Calcluate area-weighted training data site deficits
# SBC_RE1 <- SBC_RE1 %>%
#   mutate(required_ref_sites = case_when(
#     Preclear_qgis_ha <= 400 ~ 1,
#     Preclear_qgis_ha <= 800 ~ 2,
#     Preclear_qgis_ha <= 1200 ~ 3,
#     Preclear_qgis_ha <= 1600 ~ 4,
#     Preclear_qgis_ha > 1600 ~ 5
#   )) %>%
#   mutate(TD_ref_deficit = required_ref_sites - TD_ref_sites)
# SBC_RE1 <- SBC_RE1 %>%
#   mutate(required_ref_sites = case_when(
#     Preclear_qgis_ha <= 400 ~ 1,
#     Preclear_qgis_ha <= 800 ~ 2,
#     Preclear_qgis_ha <= 1200 ~ 3,
#     Preclear_qgis_ha <= 1600 ~ 4,
#     Preclear_qgis_ha > 1600 ~ 5
#   )) %>%
#   mutate(TD_ref_supplementation_deficit = required_ref_sites - TD_supplementation_ref_sites)
# SBC_RE1 <- SBC_RE1 %>%
#   mutate(required_ref_sites = case_when(
#     Preclear_qgis_ha <= 400 ~ 1,
#     Preclear_qgis_ha <= 800 ~ 2,
#     Preclear_qgis_ha <= 1200 ~ 3,
#     Preclear_qgis_ha <= 1600 ~ 4,
#     Preclear_qgis_ha > 1600 ~ 5
#   )) %>%
#   mutate(TD_ref_analogous_deficit = required_ref_sites - TD_analogous_ref_sites)
# SBC_RE1 <- SBC_RE1 %>%
#   mutate(required_ref_sites = case_when(
#     Preclear_qgis_ha <= 400 ~ 1,
#     Preclear_qgis_ha <= 800 ~ 2,
#     Preclear_qgis_ha <= 1200 ~ 3,
#     Preclear_qgis_ha <= 1600 ~ 4,
#     Preclear_qgis_ha > 1600 ~ 5
#   )) %>%
#   mutate(TD_ref_combined_deficit = required_ref_sites - TD_combined_ref_sites)
# 
# ##########################################################################################################################################################################################################################################
# 
# # 2.5) Generate training data deficit dataframe
# SBC_TD_DEFICIT <- SBC_RE1 %>%
#   select(RE1, PARENT, BR_code, LZ_code, VC_code, SHORT_DESCRIPTION, DESCRIPTION, STRUCTURE_CODE, PRECLEAR_ha, REMNANT_ha, Preclear_qgis_ha, Remnant_qgis_ha, Difference_ha, 
#          TD_ref_sites, TD_ref_deficit, TD_supplementation_ref_sites, TD_ref_supplementation_deficit, TD_analogous_ref_sites, TD_ref_analogous_deficit, TD_combined_ref_sites, 
#          TD_ref_combined_deficit, EXTENT_WITHIN_PROTECTED_AREAS, PROTECTED_AREAS, HABITAT, DISTRIBUTION, PUBLIC_COMMENTS, VMA_CLASS, BIODIVERSITY_STATUS, BIODIVERSITY_STATUS_NOTES)
# 
# SBC_TD_DEFICIT$Preclear_qgis_ha <- as.numeric(as.character(SBC_TD_DEFICIT$Preclear_qgis_ha))
# SBC_TD_DEFICIT$Remnant_qgis_ha <- as.numeric(as.character(SBC_TD_DEFICIT$Remnant_qgis_ha))

#######################################################################################################################################################################################################################################
### ---> Changed PRECLEAR_ha (REDD-derived value for Parent RE that does not account for vegetation sub unit) with Preclear_qgis_ha (Hectares calculated for each RE from extent of RE1 polygons). 
### This will stop the overestimatation of prioritisation for REs with sub units that have small extents.

# 2.6) Calculate RE training data priority
calculate_prioritisation_by_br <- function(df) {
  df <- df %>%
    group_by(BR_code) %>%
    mutate(
      # Calculate Prioritisation_Score based on TD_ref_deficit
      Prioritisation_Score = case_when(
        TD_ref_deficit <= 0 ~ NA_real_,
        TRUE ~ 50 * (Preclear_qgis_ha - min(Preclear_qgis_ha, na.rm = TRUE)) / (max(Preclear_qgis_ha, na.rm = TRUE) - min(Preclear_qgis_ha, na.rm = TRUE)) +
          30 * (Remnant_qgis_ha - min(Remnant_qgis_ha, na.rm = TRUE)) / (max(Remnant_qgis_ha, na.rm = TRUE) - min(Remnant_qgis_ha, na.rm = TRUE)) +
          20 * (TD_ref_deficit - min(TD_ref_deficit, na.rm = TRUE)) / (max(TD_ref_deficit, na.rm = TRUE) - min(TD_ref_deficit, na.rm = TRUE))
      ),
      Prioritisation_Rank = case_when(
        is.na(Prioritisation_Score) ~ NA_real_,
        TRUE ~ 100 - (Prioritisation_Score - min(Prioritisation_Score, na.rm = TRUE)) / 
          (max(Prioritisation_Score, na.rm = TRUE) - min(Prioritisation_Score, na.rm = TRUE)) * 99
      ),
      # Calculate Supplementation_Prioritisation_Score based on TD_ref_supplementation_deficit
      Supplementation_Prioritisation_Score = case_when(
        TD_ref_supplementation_deficit <= 0 ~ NA_real_,
        TRUE ~ 50 * (Preclear_qgis_ha - min(Preclear_qgis_ha, na.rm = TRUE)) / (max(Preclear_qgis_ha, na.rm = TRUE) - min(Preclear_qgis_ha, na.rm = TRUE)) +
          30 * (Remnant_qgis_ha - min(Remnant_qgis_ha, na.rm = TRUE)) / (max(Remnant_qgis_ha, na.rm = TRUE) - min(Remnant_qgis_ha, na.rm = TRUE)) +
          20 * (TD_ref_supplementation_deficit - min(TD_ref_supplementation_deficit, na.rm = TRUE)) / (max(TD_ref_supplementation_deficit, na.rm = TRUE) - min(TD_ref_supplementation_deficit, na.rm = TRUE))
      ),
      Supplementation_Prioritisation_Rank = case_when(
        is.na(Supplementation_Prioritisation_Score) ~ NA_real_,
        TRUE ~ 100 - (Supplementation_Prioritisation_Score - min(Supplementation_Prioritisation_Score, na.rm = TRUE)) / 
          (max(Supplementation_Prioritisation_Score, na.rm = TRUE) - min(Supplementation_Prioritisation_Score, na.rm = TRUE)) * 99
      ),
      # Calculate Analogous_Prioritisation_Score based on TD_ref_analogous_deficit
      Analogous_Prioritisation_Score = case_when(
        TD_ref_analogous_deficit <= 0 ~ NA_real_,
        TRUE ~ 50 * (Preclear_qgis_ha - min(Preclear_qgis_ha, na.rm = TRUE)) / (max(Preclear_qgis_ha, na.rm = TRUE) - min(Preclear_qgis_ha, na.rm = TRUE)) +
          30 * (Remnant_qgis_ha - min(Remnant_qgis_ha, na.rm = TRUE)) / (max(Remnant_qgis_ha, na.rm = TRUE) - min(Remnant_qgis_ha, na.rm = TRUE)) +
          20 * (TD_ref_analogous_deficit - min(TD_ref_analogous_deficit, na.rm = TRUE)) / (max(TD_ref_analogous_deficit, na.rm = TRUE) - min(TD_ref_analogous_deficit, na.rm = TRUE))
      ),
      Analogous_Prioritisation_Rank = case_when(
        is.na(Analogous_Prioritisation_Score) ~ NA_real_,
        TRUE ~ 100 - (Analogous_Prioritisation_Score - min(Analogous_Prioritisation_Score, na.rm = TRUE)) / 
          (max(Analogous_Prioritisation_Score, na.rm = TRUE) - min(Analogous_Prioritisation_Score, na.rm = TRUE)) * 99
      ),
      # Calculate Combined_Prioritisation_Score based on TD_ref_combined_deficit
      Combined_Prioritisation_Score = case_when(
        TD_ref_combined_deficit <= 0 ~ NA_real_,
        TRUE ~ 50 * (Preclear_qgis_ha - min(Preclear_qgis_ha, na.rm = TRUE)) / (max(Preclear_qgis_ha, na.rm = TRUE) - min(Preclear_qgis_ha, na.rm = TRUE)) +
          30 * (Remnant_qgis_ha - min(Remnant_qgis_ha, na.rm = TRUE)) / (max(Remnant_qgis_ha, na.rm = TRUE) - min(Remnant_qgis_ha, na.rm = TRUE)) +
          20 * (TD_ref_combined_deficit - min(TD_ref_combined_deficit, na.rm = TRUE)) / (max(TD_ref_combined_deficit, na.rm = TRUE) - min(TD_ref_combined_deficit, na.rm = TRUE))
      ),
      Combined_Prioritisation_Rank = case_when(
        is.na(Combined_Prioritisation_Score) ~ NA_real_,
        TRUE ~ 100 - (Combined_Prioritisation_Score - min(Combined_Prioritisation_Score, na.rm = TRUE)) / 
          (max(Combined_Prioritisation_Score, na.rm = TRUE) - min(Combined_Prioritisation_Score, na.rm = TRUE)) * 99
      )
    ) %>%
    ungroup() %>%
    # Select only the columns you want to keep
    select(-Prioritisation_Score, -Supplementation_Prioritisation_Score, -Analogous_Prioritisation_Score, -Combined_Prioritisation_Score)
  return(df)
}
SBC_TD_DEFICIT <- calculate_prioritisation_by_br(SBC_TD_DEFICIT)

#2.7) Write to csv
SBC_TD_DEFICIT <- SBC_TD_DEFICIT %>%
  select(RE1, PARENT, BR_code, LZ_code, VC_code, SHORT_DESCRIPTION, DESCRIPTION, STRUCTURE_CODE, PRECLEAR_ha, REMNANT_ha, Preclear_qgis_ha, Remnant_qgis_ha, Difference_ha, 
         TD_ref_sites, TD_ref_deficit, Prioritisation_Rank, 
         TD_supplementation_ref_sites, TD_ref_supplementation_deficit, Supplementation_Prioritisation_Rank, 
         TD_analogous_ref_sites, TD_ref_analogous_deficit, Analogous_Prioritisation_Rank, 
         TD_combined_ref_sites, TD_ref_combined_deficit, Combined_Prioritisation_Rank, 
         EXTENT_WITHIN_PROTECTED_AREAS, PROTECTED_AREAS, HABITAT, DISTRIBUTION, PUBLIC_COMMENTS, VMA_CLASS, BIODIVERSITY_STATUS,
         BIODIVERSITY_STATUS_NOTES)

outputs_folder <- "outputs"
today_date <- format(Sys.Date(), "%Y%m%d")
filename <- file.path(outputs_folder, paste0(today_date, "_SBC_trainingData_deficit.csv"))
if (file.exists(filename)) {
  file.remove(filename)
}
write.csv(SBC_TD_DEFICIT, file = filename, row.names = FALSE)
cat("CSV file created:", filename, "\n")
filename1 <- file.path(outputs_folder, paste0(today_date, "_SBC_interchangable_RES.csv"))
write.csv(SuppAna_REs, file = filename1, row.names = FALSE)
cat("CSV file created:", filename1, "\n")