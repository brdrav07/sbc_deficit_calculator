#███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗  
#██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║  
#██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║  
#██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║  
#███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║  
#╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝  
#                                                                                                                                                                      
#███████╗██████╗  ██████╗    ██████╗ ███████╗███████╗██╗ ██████╗██╗████████╗     ██████╗ █████╗ ██╗      ██████╗██╗   ██╗██╗      █████╗ ████████╗ ██████╗ ██████╗ 
#██╔════╝██╔══██╗██╔════╝    ██╔══██╗██╔════╝██╔════╝██║██╔════╝██║╚══██╔══╝    ██╔════╝██╔══██╗██║     ██╔════╝██║   ██║██║     ██╔══██╗╚══██╔══╝██╔═══██╗██╔══██╗
#███████╗██████╔╝██║         ██║  ██║█████╗  █████╗  ██║██║     ██║   ██║       ██║     ███████║██║     ██║     ██║   ██║██║     ███████║   ██║   ██║   ██║██████╔╝
#╚════██║██╔══██╗██║         ██║  ██║██╔══╝  ██╔══╝  ██║██║     ██║   ██║       ██║     ██╔══██║██║     ██║     ██║   ██║██║     ██╔══██║   ██║   ██║   ██║██╔══██╗
#███████║██████╔╝╚██████╗    ██████╔╝███████╗██║     ██║╚██████╗██║   ██║       ╚██████╗██║  ██║███████╗╚██████╗╚██████╔╝███████╗██║  ██║   ██║   ╚██████╔╝██║  ██║
#╚══════╝╚═════╝  ╚═════╝    ╚═════╝ ╚══════╝╚═╝     ╚═╝ ╚═════╝╚═╝   ╚═╝        ╚═════╝╚═╝  ╚═╝╚══════╝ ╚═════╝ ╚═════╝ ╚══════╝╚═╝  ╚═╝   ╚═╝    ╚═════╝ ╚═╝  ╚═╝
#                                                                                                                                                                      
#███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗███╗  
#██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║██╔╝╚██║  
#██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║  
#██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║██║  ██║  
#███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║███╗███║  
#╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝╚══╝  

# Authored by Brodie Verrall
# Last updated: 2025-09-01

#$$$ This script calculates the site deficit for each preclear RE1 from v14, accounting for analogous, replacement and combined REs
#TODO: ensure the latest statewide training data, analogous/replacement/combined REs, and parquets from most recent model run is maintained and imported

##### 1) Workspace setup #####
#  ██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗
# ╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝
#               ██╗       ██╗    ██╗ ██████╗ ██████╗ ██╗  ██╗███████╗██████╗  █████╗  ██████╗███████╗    ███████╗███████╗████████╗██╗   ██╗██████╗ 
#              ███║       ██║    ██║██╔═══██╗██╔══██╗██║ ██╔╝██╔════╝██╔══██╗██╔══██╗██╔════╝██╔════╝    ██╔════╝██╔════╝╚══██╔══╝██║   ██║██╔══██╗
#              ╚██║       ██║ █╗ ██║██║   ██║██████╔╝█████╔╝ ███████╗██████╔╝███████║██║     █████╗      ███████╗█████╗     ██║   ██║   ██║██████╔╝
#               ██║       ██║███╗██║██║   ██║██╔══██╗██╔═██╗ ╚════██║██╔═══╝ ██╔══██║██║     ██╔══╝      ╚════██║██╔══╝     ██║   ██║   ██║██╔═══╝ 
#               ██║██╗    ╚███╔███╔╝╚██████╔╝██║  ██║██║  ██╗███████║██║     ██║  ██║╚██████╗███████╗    ███████║███████╗   ██║   ╚██████╔╝██║     
#               ╚═╝╚═╝     ╚══╝╚══╝  ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝╚══════╝╚═╝     ╚═╝  ╚═╝ ╚═════╝╚══════╝    ╚══════╝╚══════╝   ╚═╝    ╚═════╝ ╚═╝     
#  ██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗
# ╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝
# 1.1) Run renv/activate.R to set project environment
# renv::status()
rm(list=ls())
gc()
save.image()

# 1.2) Install and load project library
# List of required packages
packages <- c("dplyr", "tidyr", "stringr", "arrow", "sf")
installed_packages <- rownames(installed.packages())
for (pkg in packages) {
  if (!pkg %in% installed_packages) {
    install.packages(pkg)
  }
}
lapply(packages, library, character.only = TRUE)

# 1.3) Create directories and set wd
current_dir <- basename(getwd())
if (current_dir == "project_data") {
  project_root <- getwd()
} else {
  project_root <- file.path(getwd(), "project_data")
}
inputs_folder  <- file.path(project_root, "inputs")
outputs_folder <- file.path(project_root, "outputs")
for (folder in c(project_root, inputs_folder, outputs_folder)) {
  if (!dir.exists(folder)) {
    dir.create(folder)
    cat("Created folder:", folder, "\n")
  } else {
    cat("Folder already exists:", folder, "\n")
  }
}
setwd(project_root)

# 1.4) Import data
TD_WOS <- read.csv("inputs/TD_WOSv7.7_20250506.csv") # TODO: ensure this is up to date ----------------------------> Updated on 06/05/25 with all trips to date
RE_v14_2025 <- read.csv("inputs/v14/regional_ecosystem.csv") # TODO: ensure this is the latest version (v14)

RE_PC_v14 <- st_read("inputs/v14/preclear_v14_3577.gpkg") %>% # TODO: read .gbd from BRI_data/RE_release and write as .gpkg in QGIS
  select("OBJECTID", "RE", "RE1", "PERCENT", "PC1", "BVG1M", "DBVG1M", "Shape_Length", "Shape_Area") %>%
  st_drop_geometry(RE_PC_v14)
    gc()
RE_RE_v14 <- st_read("inputs/v14/remnant_v14_3577.gpkg") %>% # TODO: read .gbd from BRI_data/RE_release and write as .gpkg in QGIS
  select("OBJECTID", "RE", "RE1", "PERCENT", "PC1", "BVG1M", "DBVG1M", "Shape_Length", "Shape_Area") %>%
  st_drop_geometry(RE_RE_v14)
    gc()
SBC_RE_SUPP <- read.csv("inputs/SBC_supplementation_REV13.csv") # TODO: ensure this is up to date
LRA_REs <- read.csv("inputs/SEQBRBCQCMUL_analogous_REs_v1.0.csv") # TODO: ensure this is up to date

##### 2) Data processing #####                                                                                                                                                                    
# ██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗
# ╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝
#               ██████╗        ██████╗  █████╗ ████████╗ █████╗     ██████╗ ██████╗  ██████╗  ██████╗███████╗███████╗███████╗██╗███╗   ██╗ ██████╗                
#               ╚════██╗       ██╔══██╗██╔══██╗╚══██╔══╝██╔══██╗    ██╔══██╗██╔══██╗██╔═══██╗██╔════╝██╔════╝██╔════╝██╔════╝██║████╗  ██║██╔════╝                
#                █████╔╝       ██║  ██║███████║   ██║   ███████║    ██████╔╝██████╔╝██║   ██║██║     █████╗  ███████╗███████╗██║██╔██╗ ██║██║  ███╗               
#               ██╔═══╝        ██║  ██║██╔══██║   ██║   ██╔══██║    ██╔═══╝ ██╔══██╗██║   ██║██║     ██╔══╝  ╚════██║╚════██║██║██║╚██╗██║██║   ██║               
#               ███████╗██╗    ██████╔╝██║  ██║   ██║   ██║  ██║    ██║     ██║  ██║╚██████╔╝╚██████╗███████╗███████║███████║██║██║ ╚████║╚██████╔╝               
#               ╚══════╝╚═╝    ╚═════╝ ╚═╝  ╚═╝   ╚═╝   ╚═╝  ╚═╝    ╚═╝     ╚═╝  ╚═╝ ╚═════╝  ╚═════╝╚══════╝╚══════╝╚══════╝╚═╝╚═╝  ╚═══╝ ╚═════╝                
# ██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗
# ╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝
# 2.1) Manipulate training data and calculate baseline reference state site for each RE 
TD_WOS <- TD_WOS %>%
  mutate(temp = V13_RE) %>%
  separate(temp, into = c("BR_code", "LZ_code", "VC_code"), sep = "\\.")
td_wos_ref <- TD_WOS %>%
  filter(SCORE == -1 | SCORE > 80)
td_ref_counts <- td_wos_ref %>%
  group_by(V13_RE) %>%
  summarise(TD_ref_sites = n(), .groups = 'drop')

# 2.2) Remove columns 2 to 4 to align with analogous df format, and add supp and analogous to form combined REs
QLD_RE_SUPP <- SBC_RE_SUPP[, -c(2:4)]
SuppAna_REs <- rbind(LRA_REs, QLD_RE_SUPP)

# 2.3) Manipulate regional ecosystem dataframes
RE_v14_2025 <- RE_v14_2025 %>%
  mutate(temp = NAME) %>%
  separate(temp, into = c("BR_code", "LZ_code", "VC_code"), sep = "\\.") %>%
  mutate(temp = MAPPED_EXTENTS) %>%
  separate(temp, into = c("Preclear_ha_REDD", "Remnant_ha_REDD"), sep = "\\;")
RE_v14_2025$Preclear_ha_REDD <- as.numeric(gsub("[^0-9]", "", RE_v14_2025$Preclear_ha_REDD))
RE_v14_2025$Remnant_ha_REDD <- as.numeric(gsub("2023|[^0-9]", "", RE_v14_2025$Remnant_ha_REDD))

# 2.3) Filter preclear and remnant polygons
RE_PC_v14 <- RE_PC_v14 %>%
  mutate(temp = RE1) %>%
  separate(temp, into = c("BR_code", "LZ_code", "VC_code"), sep = "\\.") %>%
  filter(!is.na(LZ_code) | LZ_code != "1")
RE_RE_v14 <- RE_RE_v14 %>%
  mutate(temp = RE1) %>%
  separate(temp, into = c("BR_code", "LZ_code", "VC_code"), sep = "\\.") %>%
  filter(!is.na(LZ_code) | LZ_code != "1")

# 2.4) Calculate cumulative preclear and remnant area of each unique RE1
RE_PC_v14_area <- RE_PC_v14 %>%
  group_by(RE1) %>%
  summarise(
    Preclear_polygons = n(),
    Preclear_ha = sum(Shape_Area, na.rm = TRUE) / 10000
  ) %>%
  ungroup()
RE_RE_v14_area <- RE_RE_v14 %>%
  group_by(RE1) %>%
  summarise(
    Remnant_polygons = n(),
    Remnant_ha = sum(Shape_Area, na.rm = TRUE) / 10000
  ) %>%
  ungroup()

# 2.5) Left join remnant to preclear
RE_extent_v14 <- RE_PC_v14_area %>%
  left_join(RE_RE_v14_area, by = c("RE1" = "RE1")) %>%
  mutate(
  Difference_ha    = Preclear_ha - Remnant_ha
  )
RE_extent_v14$RE_parent <- gsub("([a-zA-Z].*)$", "", RE_extent_v14$RE1)

##### 3) Calculate area-weighted training site deficit #####                                                                                                                                                                    
# ██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗
# ╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝
#          ██████╗         ██████╗ █████╗ ██╗      ██████╗██╗   ██╗██╗      █████╗ ████████╗███████╗    ██████╗ ███████╗███████╗██╗ ██████╗██╗████████╗
#          ╚════██╗       ██╔════╝██╔══██╗██║     ██╔════╝██║   ██║██║     ██╔══██╗╚══██╔══╝██╔════╝    ██╔══██╗██╔════╝██╔════╝██║██╔════╝██║╚══██╔══╝
#           █████╔╝       ██║     ███████║██║     ██║     ██║   ██║██║     ███████║   ██║   █████╗      ██║  ██║█████╗  █████╗  ██║██║     ██║   ██║   
#           ╚═══██╗       ██║     ██╔══██║██║     ██║     ██║   ██║██║     ██╔══██║   ██║   ██╔══╝      ██║  ██║██╔══╝  ██╔══╝  ██║██║     ██║   ██║   
#          ██████╔╝██╗    ╚██████╗██║  ██║███████╗╚██████╗╚██████╔╝███████╗██║  ██║   ██║   ███████╗    ██████╔╝███████╗██║     ██║╚██████╗██║   ██║   
#          ╚═════╝ ╚═╝     ╚═════╝╚═╝  ╚═╝╚══════╝ ╚═════╝ ╚═════╝ ╚══════╝╚═╝  ╚═╝   ╚═╝   ╚══════╝    ╚═════╝ ╚══════╝╚═╝     ╚═╝ ╚═════╝╚═╝   ╚═╝   
# ██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗██╗
# ╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝╚═╝
# 3.1) Calculate reference state site for each RE accounting for supplement REs
get_total_ref_sites <- function(re, ref_counts, QLD_RE_SUPP) {
  analogous_res <- QLD_RE_SUPP %>%
    filter(V13_RE1 == re) %>%
    unlist(use.names = FALSE) %>%
    na.omit()
  total_analogous_sites <- ref_counts %>%
    filter(V13_RE %in% analogous_res) %>%
    summarise(total_sites = sum(TD_ref_sites, na.rm = TRUE)) %>%
    pull(total_sites)
  base_re_sites <- ref_counts %>%
    filter(V13_RE == re) %>%
    summarise(base_sites = sum(TD_ref_sites, na.rm = TRUE)) %>%
    pull(base_sites)
  total_ref_sites <- if (length(analogous_res) > 0) {
    total_analogous_sites
  } else {
    base_re_sites
  }
  return(total_ref_sites)
}
td_ref_supp_counts <- td_ref_counts %>%
  rowwise() %>%
  mutate(TD_supplementation_ref_sites = get_total_ref_sites(V13_RE, td_ref_counts, QLD_RE_SUPP))

# 3.2) Calculate reference state site for each RE accounting for analogous REs
get_total_ref_sites <- function(re, ref_counts, LRA_REs) {
  analogous_res <- LRA_REs %>%
    filter(V13_RE1 == re) %>%
    unlist(use.names = FALSE) %>%
    na.omit()
  total_analogous_sites <- ref_counts %>%
    filter(V13_RE %in% analogous_res) %>%
    summarise(total_sites = sum(TD_ref_sites, na.rm = TRUE)) %>%
    pull(total_sites)
  base_re_sites <- ref_counts %>%
    filter(V13_RE == re) %>%
    summarise(base_sites = sum(TD_ref_sites, na.rm = TRUE)) %>%
    pull(base_sites)
  total_ref_sites <- if (length(analogous_res) > 0) {
    total_analogous_sites
  } else {
    base_re_sites
  }
  return(total_ref_sites)
}
td_ref_ana_counts <- td_ref_counts %>%
  rowwise() %>%
  mutate(TD_analogous_ref_sites = get_total_ref_sites(V13_RE, td_ref_counts, LRA_REs))

# 3.3) Calculate reference state site for each RE accounting for analogous & supplement (i.e. combined) REs
get_total_ref_sites <- function(re, ref_counts, SuppAna_REs) {
  analogous_res <- SuppAna_REs %>%
    filter(V13_RE1 == re) %>%
    unlist(use.names = FALSE) %>%
    na.omit()
  total_analogous_sites <- ref_counts %>%
    filter(V13_RE %in% analogous_res) %>%
    summarise(total_sites = sum(TD_ref_sites, na.rm = TRUE)) %>%
    pull(total_sites)
  base_re_sites <- ref_counts %>%
    filter(V13_RE == re) %>%
    summarise(base_sites = sum(TD_ref_sites, na.rm = TRUE)) %>%
    pull(base_sites)
  total_ref_sites <- if (length(analogous_res) > 0) {
    total_analogous_sites
  } else {
    base_re_sites
  }
  return(total_ref_sites)
}
td_ref_comb_counts <- td_ref_counts %>%
  rowwise() %>%
  mutate(TD_combined_ref_sites = get_total_ref_sites(V13_RE, td_ref_counts, SuppAna_REs))

# 3.4) Merge the reference counts with the REDD data and calculate deficits
td_all_ref_counts <- td_ref_counts %>%
  left_join(select(td_ref_supp_counts, V13_RE, TD_supplementation_ref_sites), by = c("V13_RE" = "V13_RE")) %>%
  left_join(select(td_ref_ana_counts, V13_RE, TD_analogous_ref_sites), by = c("V13_RE" = "V13_RE")) %>%
  left_join(select(td_ref_comb_counts, V13_RE, TD_combined_ref_sites), by = c("V13_RE" = "V13_RE"))
td_all_ref_counts <- td_all_ref_counts %>% # check if ref site values are the same
  mutate(all_same = (TD_supplementation_ref_sites == TD_analogous_ref_sites) & 
           (TD_analogous_ref_sites == TD_combined_ref_sites))

# 3.5) Add training site numbers for SBC mapped RE1s to be modelled
SBC_RE1 <- RE_extent_v14 %>%
  mutate(temp = RE1) %>%
  separate(temp, into = c("BR_code", "LZ_code", "VC_code"), sep = "\\.") %>%
  left_join(td_all_ref_counts, by = c("RE1" = "V13_RE")) %>%
  mutate(
    TD_ref_sites = ifelse(is.na(TD_ref_sites), 0, TD_ref_sites),
    TD_supplementation_ref_sites = ifelse(is.na(TD_supplementation_ref_sites), 0, TD_supplementation_ref_sites),
    TD_analogous_ref_sites = ifelse(is.na(TD_analogous_ref_sites), 0, TD_analogous_ref_sites),
    TD_combined_ref_sites = ifelse(is.na(TD_combined_ref_sites), 0, TD_combined_ref_sites)
  )
SBC_RE1 <- SBC_RE1 %>%
  left_join(
    RE_v14_2025 %>%
      select(
        NAME, PARENT, SHORT_DESCRIPTION, DESCRIPTION, STRUCTURE_CODE, BVG1M, DEFUNCT, Preclear_ha_REDD, Remnant_ha_REDD, EXTENT_WITHIN_PROTECTED_AREAS, 
        PROTECTED_AREAS, HABITAT, DISTRIBUTION, PUBLIC_COMMENTS, VMA_CLASS, BIODIVERSITY_STATUS, BIODIVERSITY_STATUS_NOTES 
      ),
    by = c("RE1" = "NAME") 
  )

# 3.6) Calculate area-weighted training data site deficits (robust + simpler)
SBC_RE1 <- SBC_RE1 %>%
  mutate(
    Preclear_ha = as.numeric(Preclear_ha),
    Remnant_ha  = as.numeric(Remnant_ha),
    
    # Required reference sites based on area (1–5 range)
    required_ref_sites = pmin(5, pmax(1, ceiling(Preclear_ha / 400))),
    
    # Deficits under different counting rules
    TD_ref_deficit                 = required_ref_sites - TD_ref_sites,
    TD_ref_supplementation_deficit = required_ref_sites - TD_supplementation_ref_sites,
    TD_ref_analogous_deficit       = required_ref_sites - TD_analogous_ref_sites,
    TD_ref_combined_deficit        = required_ref_sites - TD_combined_ref_sites
  )

# 3.7) Generate training data deficit dataframe
SBC_TD_DEFICIT <- SBC_RE1 %>%
  select(RE1, PARENT, BR_code, LZ_code, VC_code, SHORT_DESCRIPTION, DESCRIPTION, STRUCTURE_CODE, Preclear_ha_REDD, Remnant_ha_REDD, Preclear_ha, Preclear_polygons, Remnant_ha, Remnant_polygons, Difference_ha, 
         TD_ref_sites, TD_ref_deficit, TD_supplementation_ref_sites, TD_ref_supplementation_deficit, TD_analogous_ref_sites, TD_ref_analogous_deficit, TD_combined_ref_sites, 
         TD_ref_combined_deficit, EXTENT_WITHIN_PROTECTED_AREAS, PROTECTED_AREAS, HABITAT, DISTRIBUTION, PUBLIC_COMMENTS, VMA_CLASS, BIODIVERSITY_STATUS, BIODIVERSITY_STATUS_NOTES)

SBC_TD_DEFICIT$Preclear_ha <- as.numeric(as.character(SBC_TD_DEFICIT$Preclear_ha))
SBC_TD_DEFICIT$Remnant_ha  <- as.numeric(as.character(SBC_TD_DEFICIT$Remnant_ha))

# 3.8) Calculate RE training data priority
calculate_prioritisation_by_br <- function(df) {
  df <- df %>%
    group_by(BR_code) %>%
    mutate(
      # Calculate Prioritisation_Score based on TD_ref_deficit
      Prioritisation_Score = case_when(
        TD_ref_deficit <= 0 ~ NA_real_,
        TRUE ~ 50 * (Preclear_ha - min(Preclear_ha, na.rm = TRUE)) / (max(Preclear_ha, na.rm = TRUE) - min(Preclear_ha, na.rm = TRUE)) +
          30 * (Remnant_ha - min(Remnant_ha, na.rm = TRUE)) / (max(Remnant_ha, na.rm = TRUE) - min(Remnant_ha, na.rm = TRUE)) +
          20 * (TD_ref_deficit - min(TD_ref_deficit, na.rm = TRUE)) / (max(TD_ref_deficit, na.rm = TRUE) - min(TD_ref_deficit, na.rm = TRUE))
      ),
      Prioritisation_Rank = case_when(
        is.na(Prioritisation_Score) ~ NA_real_,
        TRUE ~ 100 - (Prioritisation_Score - min(Prioritisation_Score, na.rm = TRUE)) / 
          (max(Prioritisation_Score, na.rm = TRUE) - min(Prioritisation_Score, na.rm = TRUE)) * 99
      ),
      # Calculate Supplementation_Prioritisation_Score based on TD_ref_supplementation_deficit
      Supplementation_Prioritisation_Score = case_when(
        TD_ref_supplementation_deficit <= 0 ~ NA_real_,
        TRUE ~ 50 * (Preclear_ha - min(Preclear_ha, na.rm = TRUE)) / (max(Preclear_ha, na.rm = TRUE) - min(Preclear_ha, na.rm = TRUE)) +
          30 * (Remnant_ha - min(Remnant_ha, na.rm = TRUE)) / (max(Remnant_ha, na.rm = TRUE) - min(Remnant_ha, na.rm = TRUE)) +
          20 * (TD_ref_supplementation_deficit - min(TD_ref_supplementation_deficit, na.rm = TRUE)) / (max(TD_ref_supplementation_deficit, na.rm = TRUE) - min(TD_ref_supplementation_deficit, na.rm = TRUE))
      ),
      Supplementation_Prioritisation_Rank = case_when(
        is.na(Supplementation_Prioritisation_Score) ~ NA_real_,
        TRUE ~ 100 - (Supplementation_Prioritisation_Score - min(Supplementation_Prioritisation_Score, na.rm = TRUE)) / 
          (max(Supplementation_Prioritisation_Score, na.rm = TRUE) - min(Supplementation_Prioritisation_Score, na.rm = TRUE)) * 99
      ),
      # Calculate Analogous_Prioritisation_Score based on TD_ref_analogous_deficit
      Analogous_Prioritisation_Score = case_when(
        TD_ref_analogous_deficit <= 0 ~ NA_real_,
        TRUE ~ 50 * (Preclear_ha - min(Preclear_ha, na.rm = TRUE)) / (max(Preclear_ha, na.rm = TRUE) - min(Preclear_ha, na.rm = TRUE)) +
          30 * (Remnant_ha - min(Remnant_ha, na.rm = TRUE)) / (max(Remnant_ha, na.rm = TRUE) - min(Remnant_ha, na.rm = TRUE)) +
          20 * (TD_ref_analogous_deficit - min(TD_ref_analogous_deficit, na.rm = TRUE)) / (max(TD_ref_analogous_deficit, na.rm = TRUE) - min(TD_ref_analogous_deficit, na.rm = TRUE))
      ),
      Analogous_Prioritisation_Rank = case_when(
        is.na(Analogous_Prioritisation_Score) ~ NA_real_,
        TRUE ~ 100 - (Analogous_Prioritisation_Score - min(Analogous_Prioritisation_Score, na.rm = TRUE)) / 
          (max(Analogous_Prioritisation_Score, na.rm = TRUE) - min(Analogous_Prioritisation_Score, na.rm = TRUE)) * 99
      ),
      # Calculate Combined_Prioritisation_Score based on TD_ref_combined_deficit
      Combined_Prioritisation_Score = case_when(
        TD_ref_combined_deficit <= 0 ~ NA_real_,
        TRUE ~ 50 * (Preclear_ha - min(Preclear_ha, na.rm = TRUE)) / (max(Preclear_ha, na.rm = TRUE) - min(Preclear_ha, na.rm = TRUE)) +
          30 * (Remnant_ha - min(Remnant_ha, na.rm = TRUE)) / (max(Remnant_ha, na.rm = TRUE) - min(Remnant_ha, na.rm = TRUE)) +
          20 * (TD_ref_combined_deficit - min(TD_ref_combined_deficit, na.rm = TRUE)) / (max(TD_ref_combined_deficit, na.rm = TRUE) - min(TD_ref_combined_deficit, na.rm = TRUE))
      ),
      Combined_Prioritisation_Rank = case_when(
        is.na(Combined_Prioritisation_Score) ~ NA_real_,
        TRUE ~ 100 - (Combined_Prioritisation_Score - min(Combined_Prioritisation_Score, na.rm = TRUE)) / 
          (max(Combined_Prioritisation_Score, na.rm = TRUE) - min(Combined_Prioritisation_Score, na.rm = TRUE)) * 99
      )
    ) %>%
    ungroup() %>%
    # Select only the columns you want to keep
    select(-Prioritisation_Score, -Supplementation_Prioritisation_Score, -Analogous_Prioritisation_Score, -Combined_Prioritisation_Score)
  return(df)
}
SBC_TD_DEFICIT <- calculate_prioritisation_by_br(SBC_TD_DEFICIT)

# 3.9) Write to csv
SBC_TD_DEFICIT <- SBC_TD_DEFICIT %>%
  select(RE1, PARENT, BR_code, LZ_code, VC_code, SHORT_DESCRIPTION, DESCRIPTION, STRUCTURE_CODE, Preclear_ha_REDD, Remnant_ha_REDD, Preclear_ha, Preclear_polygons, Remnant_ha, Remnant_polygons, Difference_ha, 
         TD_ref_sites, TD_ref_deficit, Prioritisation_Rank, 
         TD_supplementation_ref_sites, TD_ref_supplementation_deficit, Supplementation_Prioritisation_Rank, 
         TD_analogous_ref_sites, TD_ref_analogous_deficit, Analogous_Prioritisation_Rank, 
         TD_combined_ref_sites, TD_ref_combined_deficit, Combined_Prioritisation_Rank, 
         EXTENT_WITHIN_PROTECTED_AREAS, PROTECTED_AREAS, HABITAT, DISTRIBUTION, PUBLIC_COMMENTS, VMA_CLASS, BIODIVERSITY_STATUS,
         BIODIVERSITY_STATUS_NOTES)

outputs_folder <- "outputs"
today_date <- format(Sys.Date(), "%Y%m%d")
filename <- file.path(outputs_folder, paste0(today_date, "_SBC_trainingData_deficit.csv"))
if (file.exists(filename)) {
  file.remove(filename)
}
write.csv(SBC_TD_DEFICIT, file = filename, row.names = FALSE)
cat("CSV file created:", filename, "\n")
filename1 <- file.path(outputs_folder, paste0(today_date, "_SBC_interchangable_RES.csv"))
write.csv(SuppAna_REs, file = filename1, row.names = FALSE)
cat("CSV file created:", filename1, "\n")

# 3.10) Join prioritisation to preclear and remnant gkpg and write
RE_PC_v14_sf <- st_read("inputs/v14/preclear_v14_3577.gpkg")
RE_RE_v14_sf <- st_read("inputs/v14/remnant_v14_3577.gpkg")
RE_PC_v14_sf <- RE_PC_v14_sf %>%
  left_join(
    SBC_TD_DEFICIT,
    by = "RE1"
  )
RE_RE_v14_sf <- RE_RE_v14_sf %>%
  left_join(
    SBC_TD_DEFICIT,
    by = "RE1"
  )
filename2 <- file.path(outputs_folder, paste0(today_date, "_RE_PC_v14_PRIORITISED.gpkg"))
if (file.exists(filename2)) {
  file.remove(filename2)
}
st_write(RE_PC_v14_sf, filename2)
cat("GeoPackage file created:", filename2, "\n")
filename3 <- file.path(outputs_folder, paste0(today_date, "_RE_RE_v14_PRIORITISED.gpkg"))
if (file.exists(filename3)) {
  file.remove(filename3)
}
st_write(RE_RE_v14_sf, filename3)
cat("GeoPackage file created:", filename3, "\n")